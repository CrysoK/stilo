{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Mi Peluquería{% endblock %}

{% block extra_head %}
<style>
  td {
    vertical-align: top;
  }

  .marked-for-deletion td {
    background-color: rgba(255, 0, 0, 0.15);
    text-decoration: line-through;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mb-4">
    Mi Peluquería
  </h2>

  {% include 'includes/hairdresser_incomplete_warning.html' with hairdresser=object %}

  <form method="post">
    {% csrf_token %}
    
    <div class="card mb-4">
      <div class="card-header">
        <h4 class="mb-0">
          Información de la peluquería
        </h4>
      </div>
      <div class="card-body">
        {{ form|crispy }}
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          Horarios de atención
        </h4>
        <button type="button" class="btn btn-primary btn-sm" data-formset-add>
          <i class="bi bi-plus"></i> Agregar horario
        </button>
      </div>
      <div class="card-body">
        {{ working_hours_formset.management_form }}
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle">
            <thead>
              <tr>
                <th>Día</th>
                <th>Hora inicio</th>
                <th>Hora fin</th>
                <th style="width: 80px">Acciones</th>
              </tr>
            </thead>
            <tbody data-formset-body>
              {% for form in working_hours_formset %}
                <tr data-formset-form>
                  <td>
                    {{ form.day_of_week }}
                    {% if form.day_of_week.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.day_of_week.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                    <div style="display: none;">
                      {{ form.id }}
                    </div>
                    {% if form.non_field_errors %}
                      <div class="invalid-feedback d-block w-100 mb-2">
                        {% for error in form.non_field_errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </td>
                  <td>
                    {{ form.start_time }}
                    {% if form.start_time.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.start_time.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </td>
                  <td>
                    {{ form.end_time }}
                    {% if form.end_time.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.end_time.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      {% if form.instance.pk %}
                      <button type="button" class="btn btn-outline-danger" data-formset-delete-button>
                        <i class="bi bi-trash"></i>
                      </button>
                      {% else %}
                      <button type="button" class="btn btn-outline-secondary" data-formset-remove-button>
                        <i class="bi bi-x-lg"></i>
                      </button>
                      {% endif %}
                    </div>
                    <div style="display: none;">
                      {{ form.DELETE }}
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if form.errors or working_hours_formset.non_form_errors %}
          <div class="alert alert-danger">
            {% if form.errors %}
              <p>Por favor corrija los errores en el formulario principal.</p>
              {% for field, errors in form.errors.items %}
                {% for error in errors %}
                  <p>{{ field }}: {{ error }}</p>
                {% endfor %}
              {% endfor %}
            {% endif %}
            {% if working_hours_formset.non_form_errors %}
              <p>Errores en los horarios de atención:</p>
              {% for error in working_hours_formset.non_form_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            {% endif %}
          </div>
        {% endif %}

        <div class="text-muted small">
          <ul class="mb-0">
            <li>Puede agregar múltiples franjas horarias por día</li>
            <li>Los horarios no pueden superponerse en el mismo día</li>
            <li>Si hay errores, no se guardará ningún cambio en los horarios</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-primary">
        Guardar cambios
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const formsetContainer = document.querySelector('[data-formset-body]');
  
  function updateElementIndex(el, prefix, ndx) {
    const pattern = new RegExp(prefix + '-(\\d+|__prefix__)-');
    const replacement = prefix + '-' + ndx + '-';
    if (el.id) el.id = el.id.replace(pattern, replacement);
    if (el.name) el.name = el.name.replace(pattern, replacement);
  }
  
  // Handle DELETE and REMOVE buttons
  function addDeleteHandler(row) {
    const deleteButton = row.querySelector('[data-formset-delete-button]');
    const removeButton = row.querySelector('[data-formset-remove-button]');
    const deleteCheckbox = row.querySelector('input[id$="-DELETE"]');
    
    // Handle toggle delete for existing rows
    if (deleteButton && deleteCheckbox) {
      deleteButton.addEventListener('click', function(e) {
        e.preventDefault();
        deleteCheckbox.checked = !deleteCheckbox.checked;
        row.classList.toggle('marked-for-deletion');
        
        // Update delete button icon
        const icon = deleteButton.querySelector('i');
        if (deleteCheckbox.checked) {
          icon.classList.remove('bi-trash');
          icon.classList.add('bi-arrow-counterclockwise');
          deleteButton.classList.remove('btn-outline-danger');
          deleteButton.classList.add('btn-outline-warning');
        } else {
          icon.classList.remove('bi-arrow-counterclockwise');
          icon.classList.add('bi-trash');
          deleteButton.classList.remove('btn-outline-warning');
          deleteButton.classList.add('btn-outline-danger');
        }
      });
    }

    // Handle immediate remove for new rows
    if (removeButton) {
      removeButton.addEventListener('click', function(e) {
        e.preventDefault();
        row.remove();
        
        // Update total forms count
        const totalFormsInput = document.querySelector('#id_working_hours-TOTAL_FORMS');
        if (totalFormsInput) {
          totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
        }
      });
    }
  }
  
  // Initialize delete handlers for existing rows
  document.querySelectorAll('[data-formset-form]').forEach(addDeleteHandler);
  
  // Handle adding new forms
  const addButton = document.querySelector('[data-formset-add]');
  const totalFormsInput = document.querySelector('#id_working_hours-TOTAL_FORMS');
  
  if (addButton && totalFormsInput && formsetContainer) {
    addButton.addEventListener('click', function(e) {
      e.preventDefault();
      const formCount = parseInt(totalFormsInput.value);
      const newRow = formsetContainer.querySelector('[data-formset-form]').cloneNode(true);
      
      // Replace delete button with remove button for new row
      const buttonGroup = newRow.querySelector('.btn-group');
      if (buttonGroup) {
        buttonGroup.innerHTML = `
          <button type="button" class="btn btn-outline-secondary" data-formset-remove-button>
            <i class="bi bi-x-lg"></i>
          </button>
        `;
      }
      
      // Update form index
      newRow.querySelectorAll('input, select').forEach(element => {
        updateElementIndex(element, 'working_hours', formCount);
        if (!element.name.endsWith('-DELETE')) {
          if (element.tagName === 'SELECT') {
            element.selectedIndex = 0;
            element.value = '';
          } else {
            element.value = '';
          }
        }
      });
      
      // Ensure the new row is visible
      newRow.style.display = '';
      
      // Add delete handler to new row
      addDeleteHandler(newRow);
      
      // Add new row and update total forms count
      formsetContainer.appendChild(newRow);
      totalFormsInput.value = formCount + 1;
    });
  }
});
</script>
{% endblock %}
